name: 🚀 Deploy UrbanMail - Postal Server

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '72.60.10.112'
  VPS_USER: 'root'
  APP_DIR: '/opt/postal'
  APP_PORT: '5000'
  IMAGE_NAME: 'postal'
  CONTAINER_NAME: 'postal'

jobs:
  deploy:
    name: 🚀 Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4

    - name: 🔑 Setup SSH
      run: |
        sudo apt-get update -qq && sudo apt-get install -y sshpass
        mkdir -p ~/.ssh && chmod 700 ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: 📦 Transfer Code
      run: |
        sudo apt-get install -y rsync
        sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --delete \
          --exclude='.git/' \
          --exclude='log/' \
          --exclude='tmp/' \
          --exclude='.claude/' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/

    - name: 🚀 Deploy with Docker
      run: |
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.APP_DIR }}
          
          # Install Docker if needed
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl start docker
            systemctl enable docker
          fi
          
          # Stop existing container
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          # Build image
          docker build -t ${{ env.IMAGE_NAME }} .
          
          # Run container
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            -p ${{ env.APP_PORT }}:5000 \
            --restart unless-stopped \
            -v /opt/postal/config:/config \
            -v /opt/postal/data:/opt/postal/data \
            ${{ env.IMAGE_NAME }}
          
          # Wait and test
          sleep 10
          if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo '✅ Deploy successful'
            docker ps | grep ${{ env.CONTAINER_NAME }}
          else
            echo '❌ Deploy failed'
            docker logs ${{ env.CONTAINER_NAME }} 2>&1 || true
            exit 1
          fi
        "

    - name: 🎉 Success
      run: |
        echo "🎉 Deploy realizado com sucesso!"
        echo "🌐 Acesso: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"